<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/static/bootstrap-table.css" rel="stylesheet">
    <link href="/static/bootstrap.css" rel="stylesheet">
    <script src="/static/jquery-1.8.2.min.js"></script>
    <script src="/static/bootstrap.min.js"></script>
    <script src="/static/bootstrap-table.js"></script>
    <script src="/static/bootstrap-table-zh-CN.js"></script>
</head>
<body>



<table  id="summary_table" class="table table-striped table-bordered table-hover">
    <thead>
    <tr>
        <td colspan="1">表名选择</td>
        <td colspan="2">
            <select id="table_name">
                <option>-请选择-</option>
            </select>

        </td>
        <td colspan="1">团队选择</td>
        <td colspan="2">
            <select id="team_name">
                <option>-请选择-</option>
            </select>
        </td>
        <td colspan="1">额定工作日</td>
        <td colspan="2"><input disabled type="number" id="workdays" name="workdays" value="0"></td>
        <td colspan="1">团队人数</td>
        <td colspan="2"><input disabled type="number" id="team_peoplenb" name="team_peoplenb" value="0"></td>
    </tr>

    <tr colspan="12">
        <th colspan="3">填报总工时</th>
        <th colspan="3">填报人均人工时</th>
        <th colspan="3">已经填报总工时</th>
        <th colspan="3">已经填报人均总工时</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td id="total_workhours" colspan="3"></td>
        <td id="avg_workhours" colspan="3"></td>
        <td id="al_total_workhours" colspan="3"></td>
        <td id="al_avg_workhours" colspan="3"></td>
    </tr>

    </tbody>
</table>


<table class="table table-striped table-bordered table-hover" id="history_info">
    <thead>
        <tr>
            <th>型号</th>
            <th>WBS编号</th>
            <th>委托部门</th>
            <th>任务内容</th>
            <th>任务说明</th>
            <th>开始时间</th>
            <th>结束时间</th>
            <th>人数</th>
            <th>工时</th>
            <th>备注</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>

    </tbody>
</table>



<form method="post" onsubmit=" return checkForm()">
    {% csrf_token %}
    <table id="info_table" class="table table-striped table-bordered table-hover">
        <thead>
            <tr>
                <th>表名</th>
                <th>型号</th>
                <th>团队</th>
                <th>WBS编号</th>
                <th>委托部门</th>
                <th>任务内容</th>
                <th>任务说明</th>
                <th>开始时间</th>
                <th>结束时间</th>
                <th>人数</th>
                <th>工时</th>
                <th>合计工时</th>
                <th>备注</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
        <tr id="row0">
<!--            <td>-->
<!--                <select id="nb0" name="nb">-->
<!--                </select>-->

<!--            </td>-->
            <td>
                <input id="nb0" name="nb" type="text" disabled>
            </td>
            <td>
                <input type="text" id="projecttype0" name="projecttype" disabled>
            </td>

<!--            <td>-->
<!--                <select id="team0" name="team">-->
<!--                </select>-->
<!--            </td>-->
            <td>
                <input id="team0" name="team" type="text" disabled>
            </td>


            <td>
                <select id="wbsNb0" name="wbsNb">
                </select>
            </td>
            <td>
                <select id="otherdepartement0" name="otherdepartement">
                    <option value="装配中心">装配中心</option>
                    <option value="试验验证中心">试验验证中心</option>
                    <option value="制造工程中心">制造工程中心</option>
                    <option value="测试中心">测试中心</option>
                    <option value="理化计量中心">理化计量中心</option>
                    <option value="工程采购中心">工程采购中心</option>
                    <option value="基地保障中心">基地保障中心</option>
                    <option value="行政事务部">行政事务部</option>
                    <option value="财务管理部">财务管理部</option>
                    <option value="生产管理部">生产管理部</option>
                    <option value="质量安全部">质量安全部</option>
                    <option value="总部各部门">总部各部门</option>
                </select>
            </td>
<!--            <td><input type="text"  id="otherdepartement0" name="otherdepartement"></td>-->


            <td><input type="text" id="description0" name="description" disabled></td>
            <td><input type="text" id="content0" name="content"></td>
            <td><input type="date" required id="start_date0" name="start_time"></td>
            <td><input type="date" required id="end_date0" name="end_time"></td>
            <td><input type="number" required id="peoplenb0" name="peoplenb"></td>
            <td><input type="number" required id="workhours0" name="workhours"></td>
            <td><input type="number" disabled name="one_workhours" id="one_workhours0" /></td>
            <td><input type="text"  id="remark0" name="remark"></td>
            <td><input type="button" name="delete"  value="删 除"  onclick="deleteSelectedRow(0)" /></td>


        </tr>

        <tr>
            <td align="center" colspan="14">
                <br />
                <input type="button" name="insert"  value="增加一行"  onclick="insertNewRow()" />&nbsp&nbsp
                <input type="button"  value=" 检查 "  onclick="GetValue()" />&nbsp&nbsp
                <input type="submit"  value=" 提交 " id="submit">
            </td>
        </tr>


        </tbody>
    </table>
</form>

<script type="text/javascript" language='javascript'>
    //声明全局变量
    var formname_data;
    var team_data;
    $(function(){
        //-----------------获取团队名-------------------------------
        $.ajax({
            type:'get', //请求方式
            url: '{% url "team"  %}', //请求地址
            dataType: 'json', //响应数据格式
            async: false, //异步请求
            success: function(res){   //请求成功后返回（响应）的回调函数
                //alert(res['data'][0]['name']);
                //alert(res);
                list = res.data;
                team_data = list;
                for(var i = 0; i < list.length; i++){
                    //$("#team0").append("<option value='"+list[i].name+"'>"+list[i].name+"</option>");
                    $("#team_name").append("<option value='"+list[i].name+"'>"+list[i].name+"</option>");
                }
            },
        });
        //-----------------获取任务名-------------------------------
        $.ajax({
            type:'get', //请求方式
            url: '{% url "task"  %}', //请求地址
            dataType: 'json', //响应数据格式
            async: false, //异步请求
            success: function(res){   //请求成功后返回（响应）的回调函数
                list = res.data
                for(var i = 0; i < list.length; i++){
                    $("#wbsNb0").append("<option value='"+list[i].wbsNb+"'>"+list[i].wbsNb+"</option>");
                }
            },
        });
        //-----------------获取表名-------------------------------
        $.ajax({
            type:'get', //请求方式
            url: '{% url "formname"  %}', //请求地址
            dataType: 'json', //响应数据格式
            async: false, //异步请求
            success: function(res){   //请求成功后返回（响应）的回调函数
                //alert(res['data'][0]['name']);
                //alert(res);
                list = res.data
                formname_data = list
                for(var i = 0; i < list.length; i++){
                    //$("#nb0").append("<option value='"+list[i].name+"'>"+list[i].name+"</option>");
                    $("#table_name").append("<option value='"+list[i].name+"'>"+list[i].name+"</option>");
                }
            },
        });
    });

    //声明全局变量
    var formvalue = "";

    var get_data;
    var submit_data;
    var flag = 1;
    var index = 1;
    var Cell1 = "";
    var Cell2 = "";
    var Cell3 = "";
    var Cell4 = "";
    var Cell5 = "";
    var Cell6 = "";
    var Cell7 = "";
    var Cell8 = "";
    var Cell9 = "";
    var Cell10 = "";
    var Cell11 = "";
    var Cell12 = "";
    var Cell13 = "";
    //初始化第一行
    $(function() {
        //初始化第一行
        Cell1 = $("#row0 td:eq(0)").html();
        Cell2 = $("#row0 td:eq(1)").html();
        Cell3 = $("#row0 td:eq(2)").html();
        Cell4 = $("#row0 td:eq(3)").html();
        Cell5 = $("#row0 td:eq(4)").html();
        Cell6 = $("#row0 td:eq(5)").html();
        Cell7 = $("#row0 td:eq(6)").html();
        Cell8 = $("#row0 td:eq(7)").html();
        Cell9 = $("#row0 td:eq(8)").html();
        Cell10 = $("#row0 td:eq(9)").html();
        Cell11 = $("#row0 td:eq(10)").html();
        Cell12 = $("#row0 td:eq(11)").html();
        Cell13 = $("#row0 td:eq(12)").html();
    });
    //-----------------新增一行-----------start---------------
    function insertNewRow() {
        var rowLength = $("#info_table tr").length;
        var rowId = "row" + flag;
        var insertStr = "<tr id=" + rowId + ">" + "<td>" + Cell1 + "</td>"+ "<td>" + Cell2 + "</td>"+ "<td>" + Cell3 + "</td>"+ "<td>" + Cell4 + "</td>"+ "<td>" + Cell5 + "</td>"+ "<td>" + Cell6 + "</td>"+ "<td>" + Cell7 + "</td>"+ "<td>" + Cell8 + "</td>"+ "<td>" + Cell9 + "</td>"+ "<td>" + Cell10 + "</td>"+ "<td>" + Cell11 + "</td>"+"<td>" + Cell12 + "</td>" +"<td>" + Cell13 + "</td>" + "<td><input type='button' name='delete' value='删除' onclick='deleteSelectedRow(\"" + rowId + "\")' />"+ "</td>"  + "</tr>";
        $("#info_table tr:eq(" + (rowLength - 2) + ")").after(insertStr);
        $("#" + rowId + " td:eq(0)").children().eq(0).attr("id", "nb" + flag);
        $("#" + rowId + " td:eq(0)").children().val($("#table_name").val());


        $("#" + rowId + " td:eq(1)").children().eq(0).attr("id", "projecttype" + flag);

        $("#" + rowId + " td:eq(2)").children().eq(0).attr("id", "team" + flag);
        $("#" + rowId + " td:eq(2)").children().val($("#team_name").val());

        $("#" + rowId + " td:eq(3)").children().eq(0).attr("id", "wbsNb" + flag);
        $("#" + rowId + " td:eq(4)").children().eq(0).attr("id", "otherdepartement" + flag);
        $("#" + rowId + " td:eq(5)").children().eq(0).attr("id", "description" + flag);
        $("#" + rowId + " td:eq(6)").children().eq(0).attr("id", "content" + flag);
        $("#" + rowId + " td:eq(7)").children().eq(0).attr("id", "start_time" + flag);
        $("#" + rowId + " td:eq(8)").children().eq(0).attr("id", "end_time" + flag);
        $("#" + rowId + " td:eq(9)").children().eq(0).attr("id", "peoplenb" + flag);
        $("#" + rowId + " td:eq(10)").children().eq(0).attr("id", "workhours" + flag);
        $("#" + rowId + " td:eq(11)").children().eq(0).attr("id", "one_workhours" + flag);
        $("#" + rowId + " td:eq(12)").children().eq(0).attr("id", "remark" + flag);
        flag++;
    }
    //-----------------删除一行，根据行ID删除-start--------
    function deleteSelectedRow(rowID) {
        if (confirm("确定删除该行吗？")) {
            $("#" + rowID).remove();
        }
    }

    //-------------------接收表单中的值并且计算总表单中的人工时和人均人工时-----------------------------
    function GetValue() {
        var value = "";
        $("#info_table tr").each(function (i) {
            if (i >= 1) {
                $(this).children().each(function (j) {

                    if ($("#info_table tr").eq(i).children().length -1 != j) {
                        value += $(this).children().eq(0).val() + "," //获取每个单元格里的第一个控件的值
                        if ($(this).children().length > 1) {
                            value += $(this).children().eq(1).val() + "," //如果单元格里有两个控件，获取第二个控件的值
                        }
                    }
                });
                value = value.substr(0, value.length - 1) + "#"; //每个单元格的数据以“，”分割，每行数据以“#”号分割
            }
        });
        value = value.substr(0, value.length);
        submit_data = value
        alert(submit_data)

        //-------------------计算表单中的总人工时和人均人工时-----------------------------
        var temp;
        var total_workhours =0;
        temp = submit_data.split("#");
        for(var i = 0; i < temp.length-1; i++){
            temp2 = temp[i].split(",");
            temp3 = Number(temp2[10]);
            temp4 = Number(temp2[9]);
            total_workhours = total_workhours + temp3 * temp4;
        }
        $("#total_workhours").empty();
        $("#total_workhours").append(total_workhours);
        $("#avg_workhours").empty();
        $("#avg_workhours").append(total_workhours/8);
    }
    //-----------------根据选择的wbs编号，得到型号和任务描述，并填充--------
    $("select[name='wbsNb']").live('change',function(){
        //alert(flag)
        var wbsnb = $(this).val();
        var current_id = $(this).attr("id").match(/[0-9]+/);
        $.ajax({
            type:'get', //请求方式
            url: "/myapp/description/"+wbsnb, //请求地址
            data: {},
            dataType: 'json',
            success: function(res){
                //获得部门info
                list = res.data;
                $("#description"+current_id).empty();
                $("#projecttype"+current_id).empty();
                $("#projecttype"+current_id).val(list[0].projecttype);
                $("#description"+current_id).val(list[0].description);

            },
        });
    });


    //-------------------获得指定表名的一些信息-----------------------------
    $("#table_name").live('change',function() {
        var tablename = $("#table_name").val();

        //填充提交表单中的表名
        $("[name='nb']").val(tablename);

        //填充额定工作日
        for(var i = 0; i < formname_data.length; i++){
            if (formname_data[i].name == tablename){
                $("#workdays").empty();
                $("#workdays").val(formname_data[i].workdays);
            }
        }

        //获得当前表下的所有信息
        $.ajax({
            type:'get', //请求方式
            url: "/myapp/get_info/"+tablename, //请求地址
            data: {},
            dataType: 'json',
            success: function(res){
                //获得部门info
                list = res.data;
                get_data =list;
            },
        });
    });
    //-------------------根据选择的表以及团队计算数据库中信息的总人工时和人均人工时并得到历史数据-----------------------------
    $("#team_name").live('change',function() {
        //-------------------计算总人工时和人均人工时-----------------------------
        var teamname = $("#team_name").val();

        //填充提交表单中的团队名
        $("[name='team']").val(teamname);

        //填充团队人数
        for(var i = 0; i < team_data.length; i++){
            if (team_data[i].name == teamname){
                $("#team_peoplenb").empty();
                $("#team_peoplenb").val(team_data[i].peoplenb);
            }
        }

        //计算总人工时
        var al_total_workhours = 0;
        for(var i = 0; i < get_data.length; i++){
            if(teamname == get_data[i].team){
                al_total_workhours = al_total_workhours+get_data[i].peopleNb*get_data[i].workhours;
            }
        };
        $("#al_total_workhours").empty();
        $("#al_total_workhours").append(al_total_workhours);

        //计算人均工时
        $("#al_avg_workhours").empty();




        $("#al_avg_workhours").append(al_total_workhours/8);

        //清空历史信息表
        $("#history_info  tr:not(:first)").empty("");
        //得到并显示历史信息
        for(var i = 0; i < get_data.length; i++){
            if(teamname == get_data[i].team){
                $("#history_info").append("<tr><td>"+list[i].projecttype+"</td><td>"+list[i].wbsNb+"</td>" +
                    "<td>"+list[i].otherdepartement+"</td><td>"+list[i].description+"</td><td>"+list[i].taskdescription+"</td>" +
                    "<td>"+list[i].starttime+"</td><td>"+list[i].endtime+"</td>" +
                    "<td>"+list[i].peopleNb+"</td><td>"+list[i].workhours+"</td><td>"+list[i].remark+"</td>" +
                    // "<td><input type='button' name='edit' value='修改' ></td></tr>");
                    "<td> <a href='/myapp/edit/"+list[i].id+"'>编辑</a></tr>");
            }
        }


    });
    //-------------------计算每一行的合计工时-----------------------------
    $("[name='workhours']").live('change',function() {
        var people = $(this).parent().prev().children().val();
        var h = $(this).val();
        var current_id = $(this).attr("id").match(/[0-9]+/);
        $("#one_workhours"+current_id).empty();
        $("#one_workhours"+current_id).val(people * h);

    });

</script>






<script type="text/javascript" language='javascript'>
    //-------------------检查表单-----------------------------
    function checkForm(){
        var check_flag2=1;
        $("#info_table tr").each(function (i) {
            var check_flag=1;
            if (i >= 1 && i < $("#info_table tr").length-1) {
                $(this).children().each(function (j) {
                    if(j == 0) {
                        if($(this).children().eq(0).val()==""){alert("请选择表名"); check_flag=0; return false;}
                    }
                    if(j == 1) {
                        if($(this).children().eq(0).val()==""){alert("请选择WBS编号"); check_flag=0; return false;}
                    }
                    if(j == 2) {
                        if($(this).children().eq(0).val()==""){alert("请选择团队"); check_flag=0; return false;}
                    }
                    if(j == 3) {
                        if($(this).children().eq(0).val()==""){alert("请选择WBS编号"); check_flag=0; return false;}
                    }
                    if(j == 5) {
                        if($(this).children().eq(0).val()==""){alert("请选择WBS编号"); check_flag=0; return false;}
                    }
                    if(j == 7) {
                        if($(this).children().eq(0).val()==""){alert("请填写开始时间"); check_flag=0; return false;}
                    }
                    if(j == 8) {
                        if($(this).children().eq(0).val()==""){alert("请填写结束时间"); check_flag=0; return false;}
                    }
                    if(j == 9) {
                        if($(this).children().eq(0).val()==""){alert("请填写人数"); check_flag=0; return false;}
                        else if($(this).children().eq(0).val()<=0){alert($(this).children().eq(0).val());   alert("请填写正数"); check_flag=0; return false;}
                    }
                    if(j == 10) {
                        if($(this).children().eq(0).val()==""){alert("请填写工时"); check_flag=0; return false;}
                        else if($(this).children().eq(0).val()<=0){alert($(this).children().eq(0).val()); alert("请填写正数"); check_flag=0; return false;}
                    }
                })
            }
            if(check_flag == 0){
                check_flag2 = 0;
                return false;
            }
        })
        if(check_flag2 == 0){
            return false;
        }else {
            return true;
        }

    }
    //-------------------发送表单中的值到后台-----------------------------
    $('#submit').click(function () {
        GetValue();
        if(checkForm()==true) {
            $.ajax({
                url: '{% url "uploadtest2" %}', //请求地址
                type: 'post',
                data: {
                    csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                    total_data: submit_data
                },
                success: function (data) {
                    data = JSON.parse(data);
                    if (data.status) {
                        window.location = data.url
                    } else {
                        alert('提交失败')
                    }
                }
            })
        }
    })

</script>



</body>
</html>